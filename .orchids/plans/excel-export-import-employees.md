# خطة تصدير واستيراد بيانات الموظفين عبر Excel

## الملخص
إضافة ميزة تصدير بيانات الموظفين الحاليين في الباقة إلى ملف Excel شامل، مع إمكانية رفع الملف بعد تحديثه لتحديث بيانات الموظفين تلقائياً.

---

## المتطلبات

### 1. تغيير نص زر التنقل بين الباقات
- تغيير النص من "التالية" إلى "الانتقال إلى الباقة التالية" ✅ (تم بالفعل في الترجمات)

### 2. زر تصدير Excel (Export)
- تصدير جميع بيانات الموظفين الحاليين في الباقة
- يشمل جميع الحقول المهمة:
  - البيانات الأساسية: الاسم، الاسم بالإنجليزية، رقم الهوية، رقم المستخدم
  - بيانات العمل: المسمى الوظيفي، الجنسية، لوحة المركبة
  - بيانات التواصل: رقم الهاتف، البريد الإلكتروني
  - البيانات المالية: الراتب الأساسي، بدل السكن، الآيبان
  - بيانات المستندات: تاريخ الميلاد، رقم الجواز، كرت التشغيل، انتهاء الإقامة
- يظهر البيانات المدخلة والفارغة بوضوح
- دعم كامل للغة العربية

### 3. زر تحديث البيانات (Import/Update)
- رفع ملف Excel المحدث
- عرض إشعار "جاري التحقق من البيانات"
- معاينة التغييرات قبل التطبيق
- مطابقة الموظفين برقم الهوية (iqama_number) أو ID
- تحديث البيانات الموجودة + إضافة النواقص
- لا يحذف البيانات الموجودة - فقط يحدثها
- إشعارات مرحلية (جاري التحقق → تم التحقق → جاري التحديث → تم بنجاح)

---

## التصميم التقني

### الملفات المطلوب تعديلها

#### 1. `app/(dashboard)/hr/packages/[id]/package-view-client.tsx`
- إضافة دالة `handleExportEmployees()` لتصدير البيانات
- إضافة دالة `handleImportUpdate()` لاستيراد وتحديث البيانات
- إضافة Modal جديد للمعاينة قبل التحديث
- تحديث زر التصدير الموجود ليعمل فعلياً

#### 2. `lib/actions/hr.ts`
- إضافة دالة `updateEmployeesBulk()` لتحديث عدة موظفين دفعة واحدة

#### 3. `messages/ar.json` و `messages/en.json`
- إضافة نصوص الإشعارات والأزرار الجديدة

---

## خطوات التنفيذ

### المرحلة 1: تصدير البيانات (Export)
1. إنشاء دالة `handleExportEmployees()` في package-view-client.tsx
2. تعريف جميع أعمدة Excel بالعربية والإنجليزية
3. تصدير بيانات الموظفين الحاليين مع:
   - عمود ID (مخفي للمطابقة)
   - جميع الحقول الـ 15+
4. تنسيق الملف بشكل احترافي

### المرحلة 2: استيراد وتحديث البيانات (Import)
1. إضافة زر "تحديث البيانات" بجانب زر التصدير
2. إنشاء دالة `handleImportUpdate()` لمعالجة الملف المرفوع
3. مطابقة الموظفين بـ iqama_number أو id
4. عرض Modal للمعاينة مع جدول يوضح:
   - الحقول التي ستتحدث
   - القيم القديمة vs الجديدة
   - عدد الموظفين المتأثرين

### المرحلة 3: نظام الإشعارات المرحلية
1. Modal متحرك يعرض المراحل:
   - المرحلة 1: "جاري التحقق من البيانات..." (مع spinner)
   - المرحلة 2: "تم التحقق - عرض المعاينة"
   - المرحلة 3: "جاري تحديث البيانات..." 
   - المرحلة 4: "تم التحديث بنجاح ✓"
2. استخدام نفس نمط `excelScanModal` الموجود

### المرحلة 4: Server Action للتحديث الجماعي
1. إضافة `updateEmployeesBulk()` في lib/actions/hr.ts
2. التحقق من صحة البيانات
3. تحديث كل موظف على حدة
4. إرجاع تقرير بالتحديثات

---

## هيكل البيانات

### أعمدة ملف Excel للتصدير
```
| # | العمود (AR)           | Column (EN)          | الحقل في DB              |
|---|----------------------|----------------------|--------------------------|
| 1 | معرف الموظف          | Employee ID          | id                       |
| 2 | اسم الموظف           | Employee Name        | name                     |
| 3 | الاسم بالإنجليزية    | Name EN              | name_en                  |
| 4 | رقم الهوية           | ID Number            | iqama_number             |
| 5 | رقم المستخدم         | User Code            | user_code                |
| 6 | المسمى الوظيفي       | Job Title            | job_title                |
| 7 | الجنسية              | Nationality          | nationality              |
| 8 | رقم الهاتف           | Phone Number         | phone                    |
| 9 | البريد الإلكتروني    | Email                | email                    |
| 10| لوحة المركبة         | Vehicle Plate        | vehicle_plate            |
| 11| تاريخ الميلاد        | Birth Date           | birth_date               |
| 12| رقم الجواز           | Passport Number      | passport_number          |
| 13| كرت التشغيل          | Operation Card       | operation_card_number    |
| 14| الراتب الأساسي       | Basic Salary         | basic_salary             |
| 15| بدل السكن            | Housing Allowance    | housing_allowance        |
| 16| انتهاء الإقامة       | Iqama Expiry         | iqama_expiry             |
| 17| الآيبان              | IBAN                 | iban                     |
| 18| الحالة               | Status               | is_active                |
```

### منطق المطابقة عند الاستيراد
```typescript
// الأولوية للمطابقة:
// 1. id (إذا موجود)
// 2. iqama_number (رقم الهوية)
// 3. name + user_code (كخيار أخير)
```

---

## واجهة المستخدم

### أزرار جديدة في شريط الجدول
```
[تصدير Excel] [تحديث من Excel]
     ↓              ↓
  تحميل ملف    رفع ملف محدث
```

### Modal المعاينة
```
┌─────────────────────────────────────────────────┐
│  معاينة التحديثات                               │
├─────────────────────────────────────────────────┤
│  سيتم تحديث 15 موظف                             │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ الموظف    │ الحقل     │ القديم  │ الجديد │   │
│  ├───────────┼───────────┼─────────┼────────┤   │
│  │ أحمد محمد │ الهاتف    │ فارغ    │ 05555  │   │
│  │ أحمد محمد │ الراتب    │ 3000    │ 3500   │   │
│  │ خالد علي  │ الجنسية   │ فارغ    │ سعودي  │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│         [إلغاء]        [تأكيد التحديث]         │
└─────────────────────────────────────────────────┘
```

---

## الترجمات المطلوبة

### العربية (ar.json)
```json
{
  "packageView": {
    "exportExcel": "تصدير Excel",
    "updateFromExcel": "تحديث من Excel",
    "exportEmployeesData": "تصدير بيانات الموظفين",
    "verifyingData": "جاري التحقق من البيانات...",
    "dataVerified": "تم التحقق من البيانات",
    "updatingData": "جاري تحديث البيانات...",
    "updateSuccess": "تم تحديث البيانات بنجاح",
    "previewChanges": "معاينة التغييرات",
    "employeesToUpdate": "موظف سيتم تحديثه",
    "fieldsToUpdate": "حقل سيتم تحديثه",
    "oldValue": "القيمة القديمة",
    "newValue": "القيمة الجديدة",
    "confirmUpdate": "تأكيد التحديث",
    "noChangesFound": "لا توجد تغييرات",
    "employeeNotFound": "موظف غير موجود",
    "matchByIqama": "المطابقة برقم الهوية",
    "exportSuccessful": "تم تصدير الملف بنجاح",
    "readingFile": "قراءة الملف...",
    "analyzingData": "تحليل البيانات...",
    "comparingData": "مقارنة البيانات..."
  }
}
```

---

## اعتبارات مهمة

1. **الأمان**: التحقق من أن الموظفين ينتمون لنفس الشركة والباقة
2. **الأداء**: استخدام batch update بدلاً من تحديث كل سجل على حدة
3. **التراجع**: لا يمكن التراجع عن التحديثات - لذا المعاينة مهمة
4. **الترميز**: استخدام UTF-8 لدعم العربية في Excel
5. **التنسيق**: الحفاظ على تنسيق التواريخ والأرقام

---

## الاختبارات المطلوبة

1. تصدير باقة فارغة
2. تصدير باقة بموظفين
3. استيراد ملف بدون تغييرات
4. استيراد ملف بتغييرات جزئية
5. استيراد ملف بموظفين غير موجودين
6. التحقق من دعم العربية
7. التحقق من صحة التواريخ والأرقام
