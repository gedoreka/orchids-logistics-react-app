# إضافة شجرة الحسابات ومراكز التكلفة للفاتورة الضريبية

## Requirements
إضافة حقول شجرة الحسابات (Chart of Accounts) ومراكز التكلفة (Cost Centers) في نموذج إنشاء الفاتورة الضريبية بتصميم فاخر:
- إضافة الحقول في المساحة البيضاء بعد قسم "التعديلات"
- جعل الحقول إجبارية (لا يُحفظ بدونها)
- قوائم منبثقة احترافية مع بحث وتصنيف شجري (رئيسي/فرعي)
- إشعارات تنبيه فاخرة عند نسيان اختيار الحساب أو مركز التكلفة
- حفظ البيانات في قاعدة البيانات وربطها بالفاتورة

## Current State Analysis

### الملفات المتأثرة:
1. **new-invoice-client.tsx** - واجهة إنشاء الفاتورة (يوجد فراغ بعد قسم التعديلات وقبل ملخص الضريبة)
2. **app/api/sales-invoices/route.ts** - API لحفظ الفاتورة
3. **lib/types.ts** - تعريفات الأنواع

### البيانات الموجودة:
- **جدول accounts**: يحتوي على شجرة الحسابات مع (account_code, account_name, type, parent_id, account_type)
- **جدول cost_centers**: يحتوي على مراكز التكلفة مع (center_code, center_name, parent_id, center_type)
- **جدول sales_invoices**: يحتاج إضافة أعمدة جديدة (account_id, cost_center_id)

### أنماط التصميم الموجودة:
- قسم التعديلات يستخدم تصميم مع header فاخر (أيقونة متدرجة، عنوان، وصف)
- الإشعارات الحالية تظهر كـ toast في الأعلى
- النظام يستخدم framer-motion للرسوم المتحركة
- القوائم المنسدلة تستخدم تصميم rounded-xl مع أيقونات

## Implementation Phases

### Phase 1: تحديث قاعدة البيانات
- [ ] إضافة عمود `account_id` (INT, nullable) لجدول sales_invoices
- [ ] إضافة عمود `cost_center_id` (INT, nullable) لجدول sales_invoices
- [ ] إنشاء API endpoint لجلب الحسابات ومراكز التكلفة

### Phase 2: تحديث واجهة NewInvoiceClient
- [ ] إضافة state للحساب المختار ومركز التكلفة المختار
- [ ] إنشاء مكون قائمة منبثقة فاخرة مع بحث (AccountSelector)
- [ ] إنشاء مكون قائمة منبثقة فاخرة مع بحث (CostCenterSelector)
- [ ] إضافة القسم الجديد في الفراغ بعد التعديلات
- [ ] تصميم فاخر يتناسب مع بقية الصفحة

### Phase 3: التحقق والإشعارات
- [ ] تحديث validateForm لإضافة التحقق من الحقول الإجبارية
- [ ] إنشاء إشعارات تنبيه فاخرة في المنتصف (مثل إشعار نسيان العميل)
- [ ] إضافة رسائل الخطأ للحقول المفقودة

### Phase 4: حفظ البيانات
- [ ] تحديث API لاستلام account_id و cost_center_id
- [ ] حفظ البيانات في جدول sales_invoices
- [ ] تحديث قيد اليومية ليشمل مركز التكلفة

### Phase 5: الاختبار والتحقق
- [ ] اختبار إنشاء فاتورة مع الحقول الجديدة
- [ ] اختبار رسائل الخطأ عند ترك الحقول فارغة
- [ ] اختبار البحث في القوائم المنبثقة
- [ ] التأكد من حفظ البيانات في قاعدة البيانات

## Technical Design

### 1. مكون AccountSelector الفاخر
```tsx
// قائمة منبثقة مع:
// - أيقونة شجرة الحسابات (BookOpen)
// - مربع بحث في الأعلى
// - تصنيف شجري (الحسابات الرئيسية تظهر أولاً ثم الفرعية)
// - ألوان مختلفة حسب نوع الحساب (أصل/خصم/دخل/مصروف)
// - زر إغلاق
```

### 2. مكون CostCenterSelector الفاخر
```tsx
// قائمة منبثقة مع:
// - أيقونة مركز التكلفة (MapPin)
// - مربع بحث
// - تصنيف شجري (رئيسي/فرعي)
// - badges للتمييز بين الرئيسي والفرعي
```

### 3. تصميم القسم الجديد
```tsx
// القسم سيكون في الـ grid مع قسم ملخص الضريبة
// - عنوان فاخر مع أيقونة متدرجة
// - حقلين (حساب + مركز تكلفة)
// - مؤشر إجباري (*)
// - رسائل خطأ أسفل كل حقل
```

### 4. إشعار التنبيه الفاخر
```tsx
// Modal في المنتصف يظهر عند محاولة الحفظ بدون اختيار:
// - أيقونة تحذير متحركة
// - عنوان واضح
// - قائمة بالحقول المفقودة
// - زر "فهمت" للإغلاق
```

### 5. تحديث الـ API
```typescript
// POST /api/sales-invoices
body: {
  // ... الحقول الحالية
  account_id: number, // إجباري
  cost_center_id: number // إجباري
}

// INSERT INTO sales_invoices
// ... + account_id, cost_center_id
```

## Database Changes

### جدول sales_invoices
```sql
ALTER TABLE sales_invoices 
ADD COLUMN account_id INT NULL,
ADD COLUMN cost_center_id INT NULL;
```

## Dependencies
- framer-motion (موجود)
- lucide-react (موجود)
- tailwindcss (موجود)

## API Endpoints Required
1. `GET /api/accounts?company_id=X` - جلب شجرة الحسابات
2. `GET /api/cost-centers?company_id=X` - جلب مراكز التكلفة (موجود)

## Risks and Mitigations
| Risk | Mitigation |
|------|------------|
| الفواتير القديمة بدون حساب/مركز تكلفة | جعل الحقول nullable في DB، والتحقق في الواجهة فقط |
| أداء تحميل القوائم الكبيرة | استخدام virtualization أو lazy loading |
| تعقيد الشجرة العميقة | عرض أول مستويين فقط مع خيار التوسيع |

## Validation Rules
1. **account_id**: إجباري - يجب اختيار حساب من الشجرة
2. **cost_center_id**: إجباري - يجب اختيار مركز تكلفة
3. الإشعار يظهر قبل إرسال الطلب للـ API

## UI/UX Specifications
- ألوان متدرجة تتناسب مع التصميم الحالي (indigo/blue للحسابات، amber للتكلفة)
- قوائم منبثقة بتأثيرات انتقالية سلسة
- بحث فوري (instant search) في القوائم
- تمييز بصري واضح للعناصر المختارة
- رسائل خطأ حمراء اللون تحت الحقول
